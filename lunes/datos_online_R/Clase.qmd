---
title: "Trabajando con datos de Global Fishing Watch"
author: "Jorge Cornejo-Donoso"
date: "`r Sys.Date()`"
output: html_document
date-format: "MMMM DD, YYYY"
format:
  html:
    toc: true
    toc-depth: 3
    lof: true
    lot: true
knitr:
   opts_chunk: 
     dev: "ragg_png"
     echo: TRUE
     warning: FALSE
     message: FALSE
     cache: TRUE
     fig.align: "center"
     fig.with: 6
     fig.height: 6
     fig.pos: "H"
editor: 
  markdown: 
    wrap: 80
---

```{r libraries, message=FALSE, warning=FALSE, echo=F}
rm(list=ls())
require(dplyr)
require(lubridate)
require(sf)
library(ggplot2)
library(ggthemes)
library(rnaturalearth)
library(rnaturalearthdata)
```


## Datos temporales


```{r}

data <- read.csv("datos/Temporal_Ecuadorian Exclusive Economic Zone (Galapagos) - 2023-01-01T00_00_00.000Z,2024-01-01T00_00_00.000Z/layer-activity-data-0/public-global-fishing-effort-v3.0.csv")

knitr::kable(head(data))
```

## Datos espaciales

```{r}

dataSP <- read.csv("datos/Espacial_Ecuadorian Exclusive Economic Zone (Galapagos) - 2023-01-01T00_00_00.000Z,2024-01-01T00_00_00.000Z/layer-activity-data-0/public-global-fishing-effort-v3.0.csv")

knitr::kable(head(dataSP))
```


# Análisis Paso a paso

## Actividad de pesca aparente por país de registro

Para analizar los datos de pesca aparente por país de registro, tenemos que
agrupar los datos por país y sumar las horas de pesca aparente para cada uno de
ellos.

Esto lo vamos a hacer en dos pasos:

1.  Actividad acumulada de pesca aparente para todo el año por país, esto lo
    presentaremos en un gráfico.\
    Para esto primero agrupamos todas las embarcaciones que pertenecen al mismo
    país (`Flag`) y que son del mismo tipo (`Vessel.Type`), para luego sumar las
    horas de pesca aparente (`Apparent.Fishing.Hours`).

```{r echo=TRUE}

hpAnual <- data %>%
  group_by(Flag, Vessel.Type) %>% 
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T))
  

```

Ahora que tenemos el número acumulado de horas podemos crear un gráfico usando
**ggplot**.

```{r fig.width=5, fig.height=3, echo=TRUE}
ggplot(hpAnual) +
  geom_col(aes(x=Flag, y=hp, colour = Vessel.Type, fill=Vessel.Type)) +
  xlab("País") +
  ylab("Horas de pesca aparente (Hrs)") +
  scale_fill_discrete(name = "Tipo") +
  scale_colour_discrete(name = "Tipo") #+
  #ggthemes::theme_few() +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

2.  Actividad mensual de pesca aparente por de pesca por país y lo presentaremos
    en un gráfico.

    El proceso en este caso es similar, pero se debe ahora agrupar también por
    el `mes`. Para esto es necesario crear la columna **mes**, esto lo hacemos
    usando la funcion `dplr::mutate` y `lubridate::month`.

```{r fig.width=8, fig.height=5, echo=TRUE}

hpMes <- data %>%
  mutate(mes = month(Time.Range)) %>%  ## <- Obtenemos el mes desde la columna de la fecha
  group_by(mes, Flag, Vessel.Type) %>% ## Incluimos el mes en el grouping
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T))

ggplot(hpMes) +
  geom_col(aes(x=Flag, y=hp, colour = Vessel.Type, fill=Vessel.Type)) +
  xlab("País") +
  ylab("Horas de pesca aparente (Hrs)") +
  scale_fill_discrete(name = "Tipo") +
  scale_colour_discrete(name = "Tipo") +
  ggthemes::theme_few() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~mes) ## <- Esto permite crear el grafico separando los meses
```

## Actividad de pesca aparente por arte de pesca

Ahora podemos hacer exactamente el mismo proceso, pero esta vez en vez de usar
el pais como variable de agrupación usamos el arte de pesca.

En esta ocasión, generamos dos data.frames en el mismo chunk de R, el anual y el
mensual.

```{r echo=TRUE}

arteAnual <- data %>%
  group_by(Gear.Type, Vessel.Type) %>% 
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T))
  

arteMensual <- data %>%
  mutate(mes = month(Time.Range)) %>%
  group_by(mes, Gear.Type, Vessel.Type) %>% 
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T))

```

Y ahora presentamos los gráficos por arte de pesca.

```{r}


ggplot(arteAnual) +
  geom_col(aes(x=Gear.Type, y=hp), fill ="darkorange") +
  xlab("Arte de Pesca") +
  ylab("Horas de pesca aparente (Hrs)") +
  scale_fill_discrete(name = "Tipo") +
  scale_colour_discrete(name = "Tipo") +
  ggthemes::theme_few() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 



```

Ahora presente el mismo tipo de gráficos, pero usamos `facet_wrap` para separar
los artes de pesca, de esto forma motramos las horas de pesca aparente para cada
mes, separando por el arte de pesca.

```{r}
ggplot(arteMensual) +
  geom_col(aes(x=Gear.Type, y=hp), fill="darkorange") +
  xlab("Arte de Pesca") +
  ylab("Horas de pesca aparente (Hrs)") +
  scale_fill_discrete(name = "Tipo") +
  scale_colour_discrete(name = "Tipo") +
  ggthemes::theme_few() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~mes) ## <- Esto permite crear el grafico separando los meses

```

## Serie temporal de actividad diaria de pesca aparente

### Para todos los países

Ahora vamos a ver como es el esfuerzo de pesca aparente diario, para esto
copararemos la actitividad total y luego por paises.

En este caso, lo que tenemos que hacer es agrupar el esfuerzo de pesca aparente
por día (sumando el esfuerzo individual de cada barco), esto luego lo podemos
hacer separando por país y/o arte de pesca.

En los gráficos anteriores vimos que Ecuador es el pías que realiza el mayor
esfuerzo en esta área. Es por esto que solo usaremos los barcos ecuatorianos
para este ejemplo. De esta forma es necesario filtrar los datos y para esto
usamos la función `dplyr::filter` .

```{r}
hpDiaEcu <- data %>%
  filter(Flag == "ECU") %>%  ## Aqui es donde filtramos para barcos de ecuador
  group_by(Time.Range) %>% ## Incluimos el mes en el grouping
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T))
```

Y ahora vemos la serie temporal.

```{r}
ggplot(hpDiaEcu) +
  geom_line(aes(x=as.Date(Time.Range), y=hp), col="darkorange") +
  xlab("Fecha") +
  ylab("Horas de pesca aparente (Hrs)") +
  ggthemes::theme_few() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### Para los países principales

Ahora haremos este gráfico temporal para los tres países (excluido Ecuador) que
realizan el mayor esfuerzo de pesca aparente en la ZEE de las islas Galápagos.

Para esto entonces necesitamos excluir los barcos con bandera de ecuador
(`filter != "ECU"`) y aquellas sin bandera conocida (`!is.na(Flag)`).

Con esto ahora, calculamos el total de horas de esfuerzo de pesca aparente por
pías.

```{r}
#| label: tbl-hpXPais
#| tbl-cap: >
#|    Horas de esfuerzo aparente de pesca total por pais.

porPais <- data %>%
  filter(Flag != "ECU", Flag != "",
         !is.na(Flag)) %>%  ## Eliminamos embarcaciones de Ecuador y aquellas sin bandera
  group_by(Flag) %>% ## Incluimos el mes en el grouping
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T)) %>% 
  arrange(desc(hp))

knitr::kable(porPais)

```

En la tabla @tbl-hpXPais que vamos que las horas de pesca de Vunuatu (VUT) y
Colombia (COL) son insignificantes y pueden corresponder a falsos positivos, es
por esto que tambien los eliminaremos del análisis.

```{r}
diaNoEcu <- data %>%
  filter(Flag == c("PAN", "NIC" ,"ESP", "VEN", "USA")) %>%
  group_by(Flag, Time.Range) %>% ## Incluimos el mes en el grouping
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T))
```

```{r}
ggplot(diaNoEcu) +
  geom_point(aes(x=as.Date(Time.Range), y=hp, col = Flag)) +
  geom_line(aes(x=as.Date(Time.Range), y=hp, col = Flag)) +
  xlab("Fecha") +
  ylab("Horas de pesca aparente (Hrs)") +
  ggthemes::theme_few() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~Flag)
```

### Para los tres artes de pesca principales

Ahora hacemos lo mismo para los artes de pesca.

```{r}
#| label: tbl-hpXArte
#| tbl-cap: >
#|    Horas de esfuerzo aparente de pesca total por arete de pesca. Artes no identificados fueron eliminados.

arteDia <- data %>% 
  filter(Gear.Type != "INCONCLUSIVE",
         Gear.Type != "OTHER",
         Gear.Type != "PASSENGER"
         ) %>% 
  group_by(Gear.Type, Time.Range) %>% ## Incluimos el mes en el grouping
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T))


data %>% 
  filter(Gear.Type != "INCONCLUSIVE",
         Gear.Type != "OTHER",
         Gear.Type != "PASSENGER"
         ) %>% 
  group_by(Gear.Type) %>% ## Incluimos el mes en el grouping
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T)) %>% 
  arrange(desc(hp)) %>% 
  knitr::kable()

```

Ahora podemos presentar estos resultados.

```{r fig.width=8}
ggplot(arteDia) +
  geom_point(aes(x=as.Date(Time.Range), y=hp, col = Gear.Type), size=.4) +
  geom_line(aes(x=as.Date(Time.Range), y=hp, col = Gear.Type), size=.4) +
  xlab("Fecha") +
  ylab("Horas de pesca aparente (Hrs)") +
  ggthemes::theme_few() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 8)  # Adjust the facet title size
    )+
  facet_wrap(~Gear.Type)
```

## Análisis espacial de la actividad de pesca aparente

Ahora trabajamos con los datos espacialesomamos los datos espaciales

### Zonas con mayor actividad de pesca aparente total anual

Aqui agrupamos los datos espaciales, sumando las horas de pesca aparente para
todo el año, en cada una de las celdas y luego lo presentamos.

```{r}
spAnual <- dataSP %>% 
  group_by(Lat, Lon) %>% 
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T))

```

Ahora hacemos el mapa

```{r}
ggplot(spAnual) +
  geom_tile(aes(x=Lon, y=Lat, z=hp))
```

Esta imágen se ve bastante mal, es necestio agregarlos las islas y mejor la
presentación en términos generales.

```{r}
# Get Galapagos land data

spAnual_sf <- st_as_sf(spAnual, coords = c("Lon", "Lat"), crs = 4326) # Lo transforma a un                                                              objeto geográfico

galapagos_land <- ne_countries(scale = "medium", returnclass = "sf") %>%
  filter(name == "Ecuador")  # Filter for Ecuador, as Galapagos belongs to Ecuador

ggplot() +
  # Add base map
  geom_sf(data = galapagos_land, fill = "grey50", color = "black") +
  # Add fishing data
  geom_tile(data = spAnual, aes(x = Lon, y = Lat, fill = hp, col=hp)) +
  # Define color gradient
  scale_color_gradient(low = "darkblue", high = "red", name = "Fishing Hours", limits = c(0, 50)) +
  scale_fill_gradient(low = "darkblue", high = "red", name = "Fishing Hours", limits = c(0, 50)) +
  scale_size_continuous(name = "Horas de Pesca Aparente") +
  labs(
    title = "Actividad de Aparente en Galapagos EEZ",
    x = "Longitud",
    y = "Latitud"
  ) +
  theme_minimal() +
  coord_sf(xlim = c(-95.5, -85), ylim = c(-4.5, 4.5))  # Adjust limits to Galapagos region

```

### Zonas con mayor actividad de pesca aparente aculada por mes

Ahora haremos el mismo gráfico, pero separados por mes.

```{r fig.height=8, fig.width=8}
spMensual <- dataSP %>% 
  mutate(mes = month(Time.Range)) %>% 
  group_by(mes, Lat, Lon) %>% 
  summarise(hp = sum(Apparent.Fishing.Hours, na.rm=T))

ggplot() +
  geom_sf(data = galapagos_land, fill = "grey50", color = "black") +
  geom_tile(data = spMensual, aes(x = Lon, y = Lat, fill = hp, col=hp)) +
  scale_color_gradient(low = "darkblue", high = "red", name = "Fishing Hours", limits = c(0, 50)) +
  scale_fill_gradient(low = "darkblue", high = "red", name = "Fishing Hours", limits = c(0, 50)) +
  scale_size_continuous(name = "Horas de Pesca Aparente") +
  labs(
    title = "Actividad de Aparente en Galapagos EEZ",
    x = "Longitud", y = "Latitud" ) +
  theme_minimal() +
  coord_sf(xlim = c(-95.5, -85), ylim = c(-4.5, 4.5))  +# Adjust limits to Galapagos region
  facet_wrap(~mes)
```
